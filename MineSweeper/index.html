<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>지뢰찾기</title>
    <style>
        body{
            padding: 50px;
        }
        table{
            border: 15px solid #EEE;
            border-collapse: collapse;
        }
        td{
            padding:0;
            margin:0;
            border-spacing: 0;
            border:1px solid #DDD;
            border-collapse: collapse;
            height:40px;
            width:40px;
            text-align: center;
            cursor:pointer;
        }

        .bomb.opened{
            background-color: red;
            /*color:#FFF;*/
        }
        .opened{
            background-color: #EEE;
            font-weight: bold;
            color:green;
        }
        .flagged{

        }
    </style>
</head>
<body>
    <table >
        <tbody id="board"></tbody>
    </table>
<script>

    /* 게임 세팅 */
    const BW = 10;
    const BH = 12;
    const bombCnt = 5;

    /* 지뢰 정보 */
    const cellCnt = BW * BH;

    let cellArr = [];
    for(let i = 0; i < cellCnt; i++){
        cellArr[i] = i;
    }

    let bombArr = [];
    for(let i = 0; i < bombCnt; i++){
        const randNum = Math.floor(Math.random() * (cellCnt - i));
        bombArr.push(cellArr[randNum]);
        cellArr.splice(randNum,1);
    }

    /* 지뢰밭 정보 */

    let cellData = new Array(cellCnt);

    function getCellData(){

        /**
         * 위치 타입
         * 모서리 : 좌상, 우상, 좌하, 우하
         * 모서리를 제외한 줄 라인: 윗줄, 이랫줄, 왼줄, 오른줄
         * 기타 9칸
         */

        const firstRow = 0;
        const firstCol = 0;
        const lastRow = BH-1;
        const lastCol = BW-1;

        let position = '';

        for(let row = 0; row< BH; row ++){

            for(let col = 0; col< BW; col ++){

                const index = row * BW + col;

                if(row === firstRow){
                    if      (col === firstCol)  position = 'topLeft';
                    else if (col === lastCol)	position = 'topRight';
                    else                        position = 'topLine';
                }

                else if(row === lastRow){
                    if      (col === firstCol)  position = 'bottomLeft';
                    else if (col === lastCol)	position = 'bottomRight';
                    else                        position = 'bottomLine';
                }

                else{
                    if      (col === firstCol)  position = 'leftLine';
                    else if (col === lastCol)	position = 'rightLine';
                    else                        position = 'inside';
                }

                cellData[index] = position;
            }

        };
    }

    getCellData();

    function getSurround(index){

        const position = cellData[index];
        let surround = [];

        const left = index - 1;
        const right = index + 1;
        const over = index - BW;
        const under = index + BW;

        Number.prototype.left = function () {return this - 1};
        Number.prototype.right = function () {return this + 1};

        switch (position) {
            case 'topLeft' :
                surround = [right, under, under.right()];
                break;

            case 'topRight' :
                surround = [left, under, under.left()];
                break;

            case 'bottomLeft' :
                surround = [over, over.right(), right];
                break;

            case 'bottomRight' :
                surround = [left, over, over.left()];
                break;

            case 'topLine' :
                surround = [left, right, under, under.left(), under.right()];
                break;

            case 'bottomLine' :
                surround = [left, right, over, over.left(), over.right()];
                break;

            case 'leftLine' :
                surround = [over, over.right(), right, under, under.right()];
                break;

            case 'rightLine' :
                surround = [over, over.left(), left, under, under.left()];
                break;

            default :
                surround = [over.left(), over, over.right(), left, right, under.left(), under, under.right()];

        }
        return surround;
    }

    /* 지뢰밭 생성 */
    const boardTable = document.getElementById('board');

    let boardElement = ''
    for(let i = 0; i< BH; i ++){
        boardElement +='<tr>';
        for(let j = 0; j< BW; j ++){
            const boxIndex = i*BW + j;
            let styleClass = '';
            let textContent = boxIndex;
//			var textContent = '🚩';
            if(bombArr.indexOf(boxIndex) > -1){
                styleClass='bomb';
                textContent = '💣'
            }
            if(boxIndex === bombArr[0]){
                styleClass='';
                textContent = '🚩';
            }
            boardElement +=`<td data-index="${boxIndex}"></td>`;
        }
        boardElement +='</tr>';
    };


    boardTable.innerHTML = boardElement;


    /* 클릭 이벤트 */
    boardTable.addEventListener('click', function(e){
        console.log(e);
        handleClickCell(Number(e.target.dataset.index));
    })

    window.oncontextmenu = (e) =>{rightClick(e)};

    function handleClickCell(index){

        const surroundCell = getSurround(index);

        /* 지뢰인지 확인 */
        const isBomb = bombArr.some(bombIndex => bombIndex === index);
        // console.log(isBomb ? 'BOMB!!' : 'No bomb');

        /* 지뢰갯수 확인 */
        const bombCnt =  surroundCell.reduce((acc, cur, i, surround) => {
            let bombCnt = bombArr.some(bombNum => bombNum === surround[i]) ? 1: 0;
            return acc + bombCnt;
        }, 0);
        // console.log(bombCnt)

        const selectedCell = boardTable.querySelector(`[data-index="${index}"]`);

        if(isBomb){
            selectedCell.innerHTML = '💣';
            selectedCell.classList.add('bomb');
        }
        else if(bombCnt === 0){
            surroundCell.forEach(item => openCell(item))
        }

        else{
            selectedCell.innerHTML = `${bombCnt}`;
        }
        selectedCell.classList.add('opened');
    }

    function openCell(index) {
        const selectedCell = boardTable.querySelector(`[data-index="${index}"]`);
        selectedCell.classList.add('opened');
    }

    function rightClick(e){

        if(e.target.nodeName !== 'TD') return;

        e.preventDefault();
        const selectedCell = e.target;

        let content = '🚩';
        if(selectedCell.textContent === '🚩'){
            content = '';
        }
        selectedCell.innerHTML = content;
        selectedCell.classList.toggle('flagged');

    }

    function cellColoring(index, bgColor) {
        const cell = boardTable.querySelector("[data-index='"+index+"']");
        cell.style.backgroundColor = bgColor
    }



</script>
</body>
</html>